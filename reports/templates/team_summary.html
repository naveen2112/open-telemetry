{% extends 'layouts/base.html' %}
{% load static %}

{% block header %}
<input type="hidden" id="team" value="{{ data.id }}">
<header class='px-2 pt-5 '>
    <a href="{% url 'team_report' %}" class='flex items-center text-sm text-dark-blue'>
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px"
            viewBox="0 0 24 24" version="1.1">
            <title>Back</title>
            <g id="Final---User-Profile" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                <g id="UserProfile---Account-Info" transform="translate(-143.000000, -15.000000)">
                    <g id="Back-Arrow" transform="translate(143.000000, 15.000000)">
                        <rect id="Rectangle" fill="#000000" fill-rule="nonzero" opacity="0"
                            transform="translate(12.000000, 12.000000) rotate(90.000000) translate(-12.000000, -12.000000) "
                            x="0" y="0" width="24" height="24" />
                        <path id="Path" fill="#2248C3"
                            d="M13.83,19.0000686 C13.5274116,19.0010289 13.2406301,18.8649915 13.05,18.63 L8.22,12.63 C7.91668285,12.2609981 7.91668285,11.7290019 8.22,11.36 L13.22,5.36 C13.5734622,4.93474075 14.2047407,4.87653778 14.63,5.23000001 C15.0552592,5.58346225 15.1134622,6.21474074 14.76,6.64 L10.29,12 L14.61,17.36 C14.8596926,17.6597233 14.9122976,18.0772862 14.7447459,18.4295743 C14.5771943,18.7818624 14.2200765,19.0045572 13.83,19.0000686 Z" />
                    </g>
                </g>
            </g>
        </svg>
        Back to Teams
    </a>
    <div class='flex justify-between items-center my-5'>
        <div class='flex items-center px-2'>
            <div>
                <p class='text-base text-dark-black mb-1'>{{ data.name }} | {{data.id}} </p>
            </div>
        </div>
    </div>
</header>
{% endblock %}

{% block sub_header %}
    {% include 'filter.html' %}
{% endblock %}

{% block table %}
<table id="overall" style="width: 100%;" class="display border-0 table-with-no-border no-footer px-2 pt-10">
    <thead style="background-color : rgb(205 211 229);">
        <th>Number of Members</th>
        <th>Capacity<br /> Man - hours</th>
        <th>Efficiency<br /> Man - hours</th>
        <th>Productivity<br /> Man - hours</th>
        <th>Gap in Efficiency <br /> Percentage</th>
        <th>Gap in Productivity <br /> Percentage</th>
    </thead>
    <tbody style="text-align : center">
        <tr>
            <td id="total_employees"></td>
            <td id="expected_daily_efficiency"></td>
            <td id="actual_daily_efficiency"></td>
            <td id="expected_monthly_efficiency"></td>
            <td id="actual_monthly_efficiency"></td>
            <td id="productivity"></td>
        </tr>
    </tbody>
</table>
{% endblock %}

{% block body %}


<table id="reports" style="width: 100%;" class="display border-0 table-with-no-border dataTable no-footer px-2 pt-10">
</table>
{% endblock %}

{% block script %}
<script>
    var start = '{{ start }}';
    var end = '{{ end }}';
    $('#leaves_range').daterangepicker({
        showDropdowns: true,
        startDate: moment(start),
        endDate: moment(end),
        maxSpan: { months: 12 },
        ranges: {
            'This Year': [moment().endOf('year').set('month', 3).set('date', 1), moment().endOf('year').add('year', 1).set('month', 2).set('date', 31)],
            'Last Year': [moment().startOf('year').subtract(1, 'year').set('month', 3).set('date', 1), moment().endOf('year').set('month', 2).set('date', 31)],
            'Last 6 months': [moment().subtract(6, 'months').startOf('month'), moment().subtract(1, 'months').endOf('month')],
            'Last 3 Months': [moment().subtract(3, 'months').startOf('month'), moment().subtract(1, 'months').endOf('month')],
            'This Month': [moment().startOf('month'), moment().endOf('month')],
            'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
        },
        alwaysShowCalendars: true
    });
    var start = $('#leaves_range').data('daterangepicker').startDate.format('DD MMM Y');
    var end = $('#leaves_range').data('daterangepicker').endDate.format('DD MMM Y')
    $('#leaves_range_display').text(start + ' - ' + end);
</script>

<script>
    $(document).ready(function () {
        $('#reports').on('xhr.dt', function (e, settings, json, xhr) {
            $("#total_employees").text(json['extra_data'][0]['members'])
            $("#expected_daily_efficiency").text(json['extra_data'][0]['capacity'])
            $("#actual_daily_efficiency").text(json['extra_data'][0]['efficiency'])
            $("#expected_monthly_efficiency").text(json['extra_data'][0]['productivity'])
            $("#actual_monthly_efficiency").text(json['extra_data'][0]['efficiency_gap'])
            $("#productivity").text(json['extra_data'][0]['productivity_gap'])
            console.log('sample : %o', json['extra_data'][0])
        });
    }); 
</script>

<script>
    $(document).ready(function () {
        AjaxDatatableViewUtils.initialize_table(
            $('#reports'),
            "{% url 'team_summary_datatable' %}",
            {
                processing: true,
                searching: true,
                serverSide: true,
                autoWidth: false,
                full_row_select: false,
                scrollX: false,
                bFilter: true,
                bSort: true,
                dom: 'ltip',
            },
            {
                'team_filter': function () {
                    var url = $("#team").val();
                    return url;
                },
                datafrom: function () { return $('#leaves_range').data('daterangepicker').startDate.format('YYYY-MM-DD') },
                dateto: function () { return $('#leaves_range').data('daterangepicker').endDate.format('YYYY-MM-DD') },
            }
        );
        $("#search_project").on('input', function () {
            var searchvalue = $(this).val();
            var table = $("#reports").DataTable();
            table.search(searchvalue).draw();
        });
        $('#leaves_range').on('apply.daterangepicker', function (ev, picker) {
            var start = picker.startDate.format('DD MMM Y');
            var end = picker.endDate.format('DD MMM Y');
            $('#leaves_range_display').text(start + ' - ' + end);
            var table = $("#reports").DataTable();
            table.ajax.reload();
            console.log('connect');
            var data = table.ajax.json();
            console.log(data);
        });
    });
</script>
{% endblock %}