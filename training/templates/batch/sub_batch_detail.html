{% extends 'layouts/base.html' %}


{% block title %}
    Sub Batch details
{% endblock title %}


{% block header %}
    <div class="flex justify-between items-center">
        <div>
            <div class="text-dark-black text-lg mb-1 leading-none">
                {{ sub_batch.name }}
            </div>
            <div class="text-dark-black-50 text-sm">

            </div>
        </div>
    </div>
{% endblock %}


{% block body %}
    <div class="flex justify-between items-center">
        <div class="bg-white rounded-xl p-5 mr-4">
            <h3 class="mb-1.5">Status</h3>
            <div class="flex justify-between items-center">
                <div class="rounded-md bg-mild-green-10 mr-4">
                    <p class="p-3 text-mild-green">Selected <span class="pl-2 font-bold text-dark-black">10</span></p>
                </div>
                <div class="rounded-md bg-dark-blue-10 mr-4">
                    <p class="p-3 text-dark-blue">Extended <span class="pl-2 font-bold text-dark-black">10</span></p>
                </div>
                <div class="rounded-md bg-orange-100 mr-4">
                    <p class="p-3 text-orange-700">Rejected <span class="pl-2 font-bold text-dark-black">10</span></p>
                </div>
                <div class="rounded-md bg-dark-red-10">
                    <p class="p-3 text-dark-red">Left <span class="pl-2 font-bold text-dark-black">10</span></p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl p-5">
            <h3 class="mb-1.5">Status</h3>
            <div class="flex justify-between items-center">
                <div class="rounded-md bg-mild-green-10 mr-4">
                    <p class="p-3 text-mild-green">Good <span class="pl-2 font-bold text-dark-black">10</span></p>
                </div>
                <div class="rounded-md bg-dark-blue-10 mr-4">
                    <p class="p-3 text-dark-blue">Meet Expectation <span class="pl-2 font-bold text-dark-black">10</span></p>
                </div>
                <div class="rounded-md bg-gray-100 mr-4">
                    <p class="p-3 text-gray-500">Above Average <span class="pl-2 font-bold text-dark-black">10</span></p>
                </div>
                <div class="rounded-md bg-orange-100 mr-4">
                    <p class="p-3 text-orange-700">Average <span class="pl-2 font-bold text-dark-black">10</span></p>
                </div>
                <div class="rounded-md bg-dark-red-10">
                    <p class="p-3 text-dark-red">Poor <span class="pl-2 font-bold text-dark-black">10</span></p>
                </div>
            </div>
        </div>
    </div>
    <div>
        <div class="flex justify-end items-center py-4">
            <a href="" class="text-dark-blue mr-4">Survey</a>
            <a href="/batch/sub-batch/{{ sub_batch.id }}/timeline" class="p-tb6 mr-4 text-white bg-dark-blue rounded inline-flex items-center px-3 py-1 text-base font-normal">Timeline</a>
            <button class="text-white bg-dark-blue rounded inline-flex items-center px-3 py-1 text-base font-normal" onclick="openModal()">
                <span class="text-xl mr-2">+</span>
                Add Trainie
            </button>
            <!-- Create Modal  -->
            <div class="jquery-modal current hidden" id="modal">
                <div class="modal py-5 rounded-xl mr-5 mt-9 bg-white" style="width: 1000px; display: inline-block;">
                    <p class="font-semibold text-lg mb-10">Create Task</p>
                    <form method="post" class="timeline-task-form" id="timeline-task-create-form">
                        <div class="modal-body">
                            {% csrf_token %}
                            <div class="work-basic-dropdown mb-7" id="{{ form.user.label|lower }}_group">
                                {{ form.user |show_label }}
                                <div class="relative">
                                    {{ form.user }}
                                </div>
                            </div>
                            <div class="mb-7" id="{{form.college.label|lower}}_group">
                                {{ form.college|show_label }}
                                {{ form.college }}
                            </div>
                        </div>
                        <div class="text-center mt-10">
                            <a class="cursor-pointer inline-block align-middle border border-grey px-8 py-2 rounded mr-6"
                                onclick="closeModal('modal')">Close</a>
                            <a class="cursor-pointer inline-block align-middle text-white bg-dark-blue rounded inline-flex items-center rounded px-8 py-2 text-base font-normal"
                                onclick="AddIntern()">Submit</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <table id="sub-batch-trainies-table" class="display border-0 table-with-no-border dataTable no-footer" style="width: 100%;" role="grid" aria-describedby="sub-batch-table_info">
        </table>
    </div>

{% endblock %} 


{% block script %}
    <script>
        $(document).ready(function(){
            $(document).ready(function () {
                AjaxDatatableViewUtils.initialize_table(
                    $('#sub-batch-trainies-table'),
                    "{% url 'batch.sub-batch-trainies-datatable' %}",
                    {
                        serverSide: true,
                        processing: true,
                        autoWidth: false,
                        scrollX: false,
                        order: [],
                    },{
                        "sub_batch": "{{ sub_batch.id }}"
                    }
                );
            });
        });

        function openModal() {
            document.getElementById("modal").classList.remove("hidden");
            document.getElementById("modal").classList.add("blocker");
        }

        function closeModal(name) {
            document.getElementById(name).classList.remove("blocker");
            document.getElementById(name).classList.add("hidden");
        }

        function AddIntern() {
            $('.page-loader').show();
            $.ajax({
                type: "POST",
                url: "{% url 'trainies.create' %}",
                headers: { 'X-CSRFToken': $("[name=csrfmiddlewaretoken]").val() },
                data: {
                    user: $('#id_user').val(),
                    college: $('#id_college').val(),
                    sub_batch: '{{sub_batch.id}}'
                },
                success: function (data) {
                    $('.form_errors').remove()
                    $('.page-loader').hide();
                    if (data.status === 'success') {
                        $('#sub-batch-trainies-table').DataTable().ajax.reload()
                        closeModal('modal');
                    }
                    else {
                        const fieldErrors = JSON.parse(data.field_errors);
                        const nonFieldErrors = JSON.parse(data.non_field_errors);
                        if (Object.keys(nonFieldErrors).length > 0) { 
                            let non_field_error = nonFieldErrors[0]['message']
                            $('#non_field_error').html('<span id="reason_error" class="ajax-error form_errors text-red-600">' + non_field_error + '</span>')
                        }
                        for (field in fieldErrors) {
                            $('#' + field + '_group').append('<span id="reason_error" class="form_errors ajax-error text-red-600">' + fieldErrors[field][0].message + '</span>');
                        }
                    }
                }
            });
        }
    </script>
{% endblock %}
